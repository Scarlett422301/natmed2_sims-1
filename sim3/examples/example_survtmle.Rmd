---
title: Example `survtmle` code
output: html_document
---

```{r, set-here, echo = FALSE}
here::i_am("examples/example_survtmle.Rmd")
```

## Installing mediation branch

The `mediation` branch of `survtmle` can be installed as follows.

```{r, install-survtmle, eval = FALSE}
devtools::install_github("benkeser/survtmle@mediation")
# devtools::load_all(here::here("../..", "survtmle"))
```

## Survival data

First, simulate some data using our function.

```{r, sim-data}
source(here::here("code", "helper_fn.R"))
data <- make_ows_data_survival(
  n = 10000, # smaller so example runs faster
  cens_rate = -3,
  covid_rate = -2,
  study_stop = 10
)
```

## Estimate total effect

The first call we make to `survtmle` will be used to estimate the total effect.

```{r, survtmle-call-1}
# choose a timepoint
set_t0 <- 5

fit1 <- survtmle::hazard_tmle(
  ftime = data$ftime,
  ftype = data$ftype,
  trt = data$vax,
  adjustVars = data[ , c("age", "race", "risk")],
  t0 = set_t0,
  glm.ctime = "age + race + risk",
  glm.ftime = "trt + age + race + risk"
)
```

## Estimate mediation parameter

The below code calls `survtmle` to estimate cumulative incidence at `t0` of an intervention that sets `trt = trtOfInterest` (i.e., `trt = 1`, i.e., vaccine) and sets mediators to their natural value under `trt = mediatorTrtVal`.

```{r, survtmle-call-2}
# choose a timepoint
set_t0 <- 5

# get sampling probabilities
glm_fit <- glm(random_subcohort ~ age*race*risk*vax,
               data = data)
samp_prob <- glm_fit$fitted.values
samp_prob[data$ftype == 1] <- 1

fit2 <- survtmle::hazard_tmle(
  ftime = data$ftime,
  ftype = data$ftype,
  trt = data$vax,
  adjustVars = data[ , c("age", "race", "risk")],
  mediator = data[ , c("ab"), drop = FALSE],
  mediatorTrtVal = 0,
  trtOfInterest = 1,
  mediatorSampProb = samp_prob,
  mediatorInCensMod = FALSE,
  t0 = set_t0,
  glm.ctime = "age + race + risk",
  glm.ftime = "trt + age + race + risk + ab",
  glm.mediator = "age*race*risk",
  glm.trtMediator = "ab + race + risk + age",
  # should be SL.eif to be more flexible?
  glm.eif = "age + race + risk + trt + ftype + ftime"
)
```

## Combine output to get in/direct effects and CI's

Here's a helper function to output total, in/direct effects, CI's.

```{r, compute-mediation-params}
compute_mediation_params <- function(
  normal_survtmle_fit,
  mediation_survtmle_fit,
  ...
){
  # will have duplicate colnames
  all_ic <- cbind(normal_survtmle_fit$ic, 
                  mediation_survtmle_fit$ic)
  est <- c(normal_survtmle_fit$est[,1], 
           mediation_survtmle_fit$est[,1])
  cov_mat <- cov(all_ic) / dim(all_ic)[1]
  A <- matrix(c(
    -1 / est[1], 1 / est[2],     0      , 
       0       , 1 / est[2], -1 / est[3],
    -1 / est[1],      0    ,  1 / est[3]
  ), nrow = 3, ncol = 3, byrow = TRUE)

  log_total_eff <- log(est[2] / est[1])
  log_indirect_eff <- log(est[2] / est[3])
  log_direct_eff <- log(est[3] / est[1])
  log_effs <- c(log_total_eff, log_indirect_eff, log_direct_eff)
  ses_log_eff <- sqrt(diag(A %*% cov_mat %*% t(A)))

  cils <- exp(log_effs - 1.96 * ses_log_eff)
  cius <- exp(log_effs + 1.96 * ses_log_eff)
  out <- data.frame(est = exp(log_effs), cil = cils, ciu = cius)
  row.names(out) <- c("Total", "Indirect", "Direct")

  return(out)
}

compute_mediation_params(fit1, fit2)
```



